@if (isOpen) {
  <div class="modal-overlay" (click)="onClose()">
    <div class="modal-container" (click)="$event.stopPropagation()">

      <div class="modal-header">
        <h2>{{ isEditMode ? 'Editar Usuário' : 'Cadastrar Novo Usuário' }}</h2>
        <button class="close-btn" (click)="onClose()">
          <i class="material-icons">close</i>
        </button>
      </div>

      <div class="modal-body">
        <form [formGroup]="userForm" (ngSubmit)="onSubmit()">

          <div class="form-row">
            <div class="form-group full-width">
              <label for="name">Nome Completo *</label>
              <input
                id="name"
                type="text"
                formControlName="name"
                placeholder="Digite o nome completo"
                [class.invalid]="isFieldInvalid('name')"
              />
              @if (isFieldInvalid('name')) {
                <span class="error-message">{{ getErrorMessage('name') }}</span>
              }
            </div>
          </div>

          <div class="form-row">
            <div class="form-group full-width">
              <label for="email">E-mail *</label>
              <input
                id="email"
                type="email"
                formControlName="email"
                placeholder="exemplo@email.com"
                [class.invalid]="isFieldInvalid('email')"
              />
              @if (isFieldInvalid('email')) {
                <span class="error-message">{{ getErrorMessage('email') }}</span>
              }
            </div>
          </div>

          @if (isEditMode) {
            <div class="password-section">
              @if (isUserProfile) {
                <div class="form-row password">
                  <div class="form-group full-width">
                    <label for="currentPassword">Senha Atual *</label>
                    <input
                      id="currentPassword"
                      type="password"
                      formControlName="currentPassword"
                      placeholder="Digite a senha atual"
                      autocomplete="new-password"
                      [class.invalid]="hasCurrentPasswordError()"
                    />
                    @if (hasCurrentPasswordError()) {
                      <span class="error-message">Senha atual obrigatória para alterar senha</span>
                    }
                  </div>
                </div>
              }

              <div class="form-row">
                <div class="form-group">
                  <label for="newPassword">Nova Senha</label>
                  <input
                    id="newPassword"
                    type="password"
                    formControlName="newPassword"
                    placeholder="Digite a nova senha"
                    autocomplete="new-password"
                    [class.invalid]="isFieldInvalid('newPassword')"
                  />
                  @if (isFieldInvalid('newPassword')) {
                    <span class="error-message">{{ getErrorMessage('newPassword') }}</span>
                  }
                </div>

                <div class="form-group">
                  <label for="confirmPassword">Confirmar Nova Senha</label>
                  <input
                    id="confirmPassword"
                    type="password"
                    formControlName="confirmPassword"
                    placeholder="Confirme a nova senha"
                    autocomplete="new-password"
                    [class.invalid]="hasPasswordMismatch()"
                  />
                  @if (hasPasswordMismatch()) {
                    <span class="error-message">As senhas não coincidem</span>
                  }
                </div>
              </div>
            </div>
          }

          <div class="form-row">
            <div class="form-group">
              <label for="role">Permissão *</label>
              <select
                id="role"
                formControlName="role"
                [class.invalid]="isFieldInvalid('role')"
              >
                @for (role of roles; track role) {
                  <option [value]="role">{{ role }}</option>
                }
              </select>
              @if (isFieldInvalid('role')) {
                <span class="error-message">{{ getErrorMessage('role') }}</span>
              }
            </div>
            <div class="form-group">
              <label for="phone">Telefone *</label>
              <input
                id="phone"
                type="text"
                formControlName="phoneNumber"
                placeholder="(00) 00000-0000"
                (input)="onPhoneInput($event)"
                [class.invalid]="isFieldInvalid('phoneNumber')"
              />
              @if (isFieldInvalid('phoneNumber')) {
                <span class="error-message">{{ getErrorMessage('phoneNumber') }}</span>
              }
            </div>
          </div>

          <div class="form-row">
            <div class="form-group full-width">
              <label for="address">Endereço *</label>
              <input
                id="address"
                type="text"
                formControlName="address"
                placeholder="Rua, número, complemento"
                [class.invalid]="isFieldInvalid('address')"
              />
              @if (isFieldInvalid('address')) {
                <span class="error-message">{{ getErrorMessage('address') }}</span>
              }
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="city">Cidade *</label>
              <input
                id="city"
                type="text"
                formControlName="city"
                placeholder="Nome da cidade"
                [class.invalid]="isFieldInvalid('city')"
              />
              @if (isFieldInvalid('city')) {
                <span class="error-message">{{ getErrorMessage('city') }}</span>
              }
            </div>
            <div class="form-group">
              <label for="uf">UF *</label>
              <select
                id="uf"
                formControlName="uf"
                [class.invalid]="isFieldInvalid('uf')"
              >
                <option value="">Selecione</option>
                @for (uf of ufs; track uf) {
                  <option [value]="uf">{{ uf }}</option>
                }
              </select>
              @if (isFieldInvalid('uf')) {
                <span class="error-message">{{ getErrorMessage('uf') }}</span>
              }
            </div>
          </div>

        </form>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn-cancel" (click)="onClose()">
          Cancelar
        </button>
        <button type="button" class="btn-save" (click)="onSubmit()" [disabled]="userForm.invalid">
          <i class="material-icons">save</i>
          Salvar
        </button>
      </div>

    </div>
  </div>
}
